

var lgb = (function(lgb) {

	lgb.controller = lgb.controller || {};
	
	
	/**
	 * @class MVC controller for the building envelope
	 * @extends lgb.controller.ControllerBase
	 */
	lgb.controller.MainControllerNew = function() {
		
		lgb.controller.ControllerBase.call(this);

		//this.dataModel = new lgb.model.EnvelopeModel();
	//	this.view = new lgb.view.EnvelopeView();

	};
	
	
	lgb.controller.MainControllerNew.prototype = {
		
		init: function() {
			
			jQuery(document).ready(this.d(this.onDocumentReady));
			jQuery(window).resize(this.d(this.onWindowResize));
			jQuery(window).unload(this.d(this.onWindowUnload));

			//mainController.progressbar = null; // the progress bar that we display

		},
		
		onDocumentReady : function(event) {
		
			console.log("kuda version: " + hemi.version);
			console.log("lgb version: " + lgb.version);
			console.log("jQuery version: " + $().jquery);
			
			lgb.view.gui.init();
			lgb.animation.init();
			lgb.utils.init();
			
			this.eventBus = $(new lgb.event.EventBus());
		
			this.envelopeController = new lgb.controller.EnvelopeController();
			this.envelopeController.init();
			
			this.leftNavController = new lgb.controller.LeftNavController();
			this.leftNavController.init();
			
			this.adminController = new lgb.controller.AdminController();
			this.adminController.init([this.envelopeController.dataModel]);
			
			var envelopeMeshList = this.envelopeController.getMeshList();
			
			var allMeshes = [];
			allMeshes = allMeshes.concat(envelopeMeshList);
			
			this.progressbar = new lgb.progressBar.Progressbar();	
			this.progressbar.init("Loading Geometry");
			this.progressbar.show(); 
				
	
			lgb.loader.init();
			lgb.view.gui.setCanvasSize();
			
			lgb.loader.loadModels(  this.d(this.onMeshesLoaded), 
									this.d(this.onProgress),
									allMeshes );

		},
		
		onWindowResize : function(event) {
			lgb.view.gui.resizeNow();
		},
		
		onWindowUnload : function(event) {
			//alert('Handler for .unload() called.');
			if (hemi.core.client) {
				hemi.core.client.cleanup();
			}
		},
		
		onMeshesLoaded : function(event) {
			hemi.world.camera.unsubscribe(this.subscriberCameraStopped, hemi.msg.stop);
	
			this.dispatch(lgb.event.Event.ALL_MESHES_LOADED);
				
			//console.log('onMeshesLoaded');
	
			//window.setTimeout('mainControllerNew.progressbar.hide();',100);
			hemi.world.camera.enableControl();	// Enable camera mouse control
	
			lgb.utils.preload('icon_exterior_envelope_over.png,icon_lighting_over.png,icon_general_over.png,icon_exterior_envelope_over.png');
			this.setViewPoint();
		
		},
	
		parseXml : function(xml) {
			lgb.view.gui.particleSystemInit(xml);
		},
		
		setViewPoint : function() {
		
			this.makeBoxAtOrigin();
	
			
			var vp = new hemi.view.Viewpoint();		// Create a new Viewpoint
			vp.eye = [0,0,80];					// Set viewpoint eye
			vp.target = [0,0,0];					// Set viewpoint target
			
			this.subscriberCameraStopped = hemi.world.camera.subscribe(
					hemi.msg.stop,
					this,
					'onCameraMoved');
					
			hemi.world.camera.moveToView(vp,40);
		
		},
	
		makeBoxAtOrigin : function() {
			var shapeGreenTarget = hemi.shape.create({
				shape: 'box',
				color: [0, 1, 0, 0.9],
				h: 1,
				w: 1,
				d: 1
			});
			
		},
		
		onCameraMoved : function(event) {
			
			console.log('onCameraMoved');
			var result = hemi.world.camera.unsubscribe(this.subscriberCameraStopped, hemi.msg.stop);
			lgb.view.gui.showHud();
		
			lgb.utils.preload('icon_exterior_envelope_over.png,icon_lighting_over.png,icon_general_over.png,icon_exterior_envelope_over.png');
		},
		
		onProgress : function(percent) {
			this.progressbar.onProgress(percent);
		}
	
	};
	
	lgb.controller.MainControllerNew.inheritsFrom(lgb.controller.ControllerBase);

	return lgb;
	
})(lgb || {});










